import React, { useState, useEffect } from "react";
import axios from "axios";

const ChooseOrder = ({ orders = [], onAddOrder, onUpdate, onDelete }) => {
  const [showAddForm, setShowAddForm] = useState(false);
  const [showEditForm, setShowEditForm] = useState(false);
  const [selected, setSelected] = useState(null);
  const [showDetailsDialog, setShowDetailsDialog] = useState(false);
  const [orderItems, setOrderItems] = useState([]);
  const [loadingDetails, setLoadingDetails] = useState(false);
  const [products, setProducts] = useState([]);
  const [tables, setTables] = useState([]);
  const [searchTerm, setSearchTerm] = useState("");

  const [newOrder, setNewOrder] = useState({
    table_id: "",
    items: [],
  });

  const [editOrder, setEditOrder] = useState({});

  // Fetch products and tables
  useEffect(() => {
    const fetchData = async () => {
      try {
        const [productsRes, tablesRes] = await Promise.all([
          axios.get("http://localhost:8080/api/products"),
          axios.get("http://localhost:8080/api/table"),
        ]);
        setProducts(productsRes.data.data || []);
        setTables(tablesRes.data.data || []);
      } catch (error) {
        console.error("Error fetching data:", error);
      }
    };
    fetchData();
  }, []);

  // Filter orders
  const filteredOrders = orders.filter(order => {
    const searchLower = searchTerm.toLowerCase();
    return (
      order.id?.toString().includes(searchLower) ||
      order.table?.id?.toString().includes(searchLower) ||
      order.status?.toLowerCase().includes(searchLower) ||
      order.total_amount?.toString().includes(searchLower)
    );
  });

  // Add
  const handleAddSubmit = (e) => {
    e.preventDefault();
    if (!newOrder.table_id) {
      alert("Please select a table");
      return;
    }
    if (newOrder.items.length === 0) {
      alert("Please add at least 1 item");
      return;
    }
    
    // Add subtotal and totalAmount
    const orderData = {
      table_id: newOrder.table_id,
      totalAmount: newOrder.items.reduce((sum, item) => sum + calculateSubtotal(item), 0),
      items: newOrder.items.map(item => ({
        product_id: item.product_id,
        quantity: item.quantity,
        subtotal: calculateSubtotal(item),
        notes: item.notes || "",
      })),
    };
    
    onAddOrder(orderData);
    setShowAddForm(false);

    setNewOrder({
      table_id: "",
      items: [],
    });
  };

  // Add order item to new order
  const addItemToNewOrder = () => {
    const newItem = {
      id: Date.now(),
      product_id: "",
      quantity: 1,
      notes: "",
    };
    setNewOrder({
      ...newOrder,
      items: [...newOrder.items, newItem],
    });
  };

  // Remove order item from new order
  const removeItemFromNewOrder = (itemId) => {
    setNewOrder({
      ...newOrder,
      items: newOrder.items.filter((item) => item.id !== itemId),
    });
  };

  // Update order item in new order
  const updateItemInNewOrder = (itemId, field, value) => {
    setNewOrder({
      ...newOrder,
      items: newOrder.items.map((item) =>
        item.id === itemId ? { ...item, [field]: value } : item
      ),
    });
  };

  // Calculate subtotal for item
  const calculateSubtotal = (item) => {
    if (!item.product_id || !item.quantity) return 0;
    const product = products.find((p) => p.id === parseInt(item.product_id));
    return product ? product.price * item.quantity : 0;
  };

  // Update
  const handleUpdateSubmit = (e) => {
    e.preventDefault();
    
    // Backend will delete old items and create new ones, so no need to send item id
    const orderData = {
      id: editOrder.id,
      table_id: editOrder.table_id,
      status: editOrder.status,
      totalAmount: editOrder.items.reduce((sum, item) => sum + calculateEditSubtotal(item), 0),
      items: editOrder.items.map(item => ({
        product_id: item.product_id || item.product?.id,
        quantity: item.quantity,
        subtotal: calculateEditSubtotal(item),
        notes: item.notes || "",
      })),
    };
    
    console.log("Update Order Data:", orderData);
    onUpdate(orderData);
    setShowEditForm(false);
  };

  // Add item to editing order
  const addItemToEditOrder = () => {
    const newItem = {
      id: Date.now(),
      product_id: "",
      quantity: 1,
      notes: "",
    };
    setEditOrder({
      ...editOrder,
      items: [...(editOrder.items || []), newItem],
    });
  };

  // Remove item from editing order
  const removeItemFromEditOrder = (itemId) => {
    setEditOrder({
      ...editOrder,
      items: editOrder.items.filter((item) => item.id !== itemId),
    });
  };

  // Update item in editing order
  const updateItemInEditOrder = (itemId, field, value) => {
    setEditOrder({
      ...editOrder,
      items: editOrder.items.map((item) => {
        if (item.id === itemId) {
          const updatedItem = { ...item, [field]: value };
          // N·∫øu thay ƒë·ªïi product_id, x√≥a product object c≈©
          if (field === 'product_id') {
            delete updatedItem.product;
          }
          return updatedItem;
        }
        return item;
      }),
    });
  };

  // Calculate subtotal for item in edit
  const calculateEditSubtotal = (item) => {
    if (!item.product_id && !item.product) return 0;
    if (!item.quantity) return 0;
    
    const product = products.find((p) => p.id === parseInt(item.product_id || item.product?.id));
    if (product) return product.price * item.quantity;
    
    // If product not found (pre-existing item), use existing product object
    if (item.product) return item.product.price * item.quantity;
    
    return 0;
  };

  // fetch order details
  const fetchOrderDetails = (order) => {
    setOrderItems(order.items || []);
    setEditOrder(order);
    setShowDetailsDialog(true);
  };

  return (
    <>
      <h1 className="title">Orders</h1>
      <p className="breadcrumb">Home / Order Management</p>

      <div className="actions">
        <div className="search-box">
          <input 
            type="text" 
            placeholder="Search by ID, table, status..." 
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
          />
        </div>
        <button className="btn filter-btn">Filter</button>
        <button className="btn add-btn" onClick={() => setShowAddForm(true)}>
          + Add Order
        </button>
      </div>

      <table className="product-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Table</th>
            <th>Status</th>
            <th>Items</th>
            <th>Total Amount</th>
            <th>Created At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {filteredOrders.length > 0 ? (
            filteredOrders.map((value) => (
              <tr key={value.id}>
                <td>#{value.id}</td>
                <td>Table {value.table?.id || value.table_id}</td>
                <td>
                  <span className={`status-badge status-${value.status?.toLowerCase()}`}>
                    {value.status}
                  </span>
                </td>
                <td>
                  <span style={{ 
                    background: 'var(--primary-light)', 
                    color: 'var(--primary-color)',
                    padding: '4px 12px',
                    borderRadius: '12px',
                    fontWeight: 600,
                    fontSize: '13px'
                  }}>
                    {value.items?.length || 0} items
                  </span>
                </td>
                <td style={{ fontWeight: 600, color: 'var(--primary-color)' }}>
                  {value.total_amount?.toLocaleString("en-US")}‚Ç´
                </td>
                <td>
                  {value.createdAt
                    ? new Date(value.createdAt).toLocaleString('en-US', {
                        day: '2-digit',
                        month: '2-digit', 
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                      })
                    : "‚Äî"}
                </td>
                <td>
                  <div style={{ display: 'flex', gap: '8px' }}>
                    <button
                      className="btn-detail"
                      onClick={() => fetchOrderDetails(value)}
                    >
                      Details
                    </button>
                    <div className="dropdown">
                      <button
                        className="action-btn"
                        onClick={() =>
                          setSelected(selected === value.id ? null : value.id)
                        }
                      >
                        ‚ãÆ
                      </button>

                      {selected === value.id && (
                        <div className="dropdown-menu">
                          {value.status !== 'Canceled' && value.status !== 'Delivered' && (
                            <button
                              onClick={() => {
                                setEditOrder({
                                  ...value,
                                  items: value.items || [],
                                });
                                setShowEditForm(true);
                                setSelected(null);
                              }}
                            >
                              Edit
                            </button>
                          )}
                          <button
                            onClick={() => {
                              onDelete(value.id);
                              setSelected(null);
                            }}
                            className="delete-btn"
                          >
                            Delete
                          </button>
                        </div>
                      )}
                    </div>
                  </div>
                </td>
              </tr>
            ))
          ) : (
            <tr>
              <td colSpan="7">No orders yet</td>
            </tr>
          )}
        </tbody>
      </table>

      {/* --- Add Modal --- */}
      {showAddForm && (
        <div className="modal-overlay">
          <div className="modal" style={{ maxWidth: "700px" }}>
            <h2>Th√™m ƒë∆°n h√†ng</h2>
            <form onSubmit={handleAddSubmit}>
              <div>
                <label>B√†n</label>
                <select
                  value={newOrder.table_id}
                  onChange={(e) =>
                    setNewOrder({
                      ...newOrder,
                      table_id: parseInt(e.target.value),
                    })
                  }
                  required
                >
                  <option value="">-- Ch·ªçn b√†n --</option>
                  {tables.map((table) => (
                    <option key={table.id} value={table.id}>
                      B√†n {table.id} - {table.status}
                    </option>
                  ))}
                </select>
              </div>

              <div style={{ marginTop: "20px" }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "12px" }}>
                  <label style={{ margin: 0 }}>Danh s√°ch m√≥n</label>
                  <button
                    type="button"
                    className="btn add-btn"
                    style={{ padding: "8px 16px", fontSize: "13px" }}
                    onClick={addItemToNewOrder}
                  >
                    + Th√™m m√≥n
                  </button>
                </div>

                {newOrder.items.length > 0 ? (
                  <div style={{ display: "flex", flexDirection: "column", gap: "12px" }}>
                    {newOrder.items.map((item, index) => (
                      <div
                        key={item.id}
                        style={{
                          border: "1px solid var(--border-color)",
                          borderRadius: "8px",
                          padding: "12px",
                          background: "var(--bg-secondary)",
                        }}
                      >
                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "8px" }}>
                          <strong>M√≥n #{index + 1}</strong>
                          <button
                            type="button"
                            onClick={() => removeItemFromNewOrder(item.id)}
                            style={{
                              background: "var(--danger-color)",
                              color: "white",
                              border: "none",
                              borderRadius: "6px",
                              padding: "4px 12px",
                              cursor: "pointer",
                              fontSize: "12px",
                            }}
                          >
                            X√≥a
                          </button>
                        </div>

                        <div style={{ display: "grid", gap: "8px" }}>
                          <div>
                            <label style={{ fontSize: "13px", display: "block", marginBottom: "4px" }}>
                              S·∫£n ph·∫©m
                            </label>
                            <select
                              value={item.product_id}
                              onChange={(e) =>
                                updateItemInNewOrder(
                                  item.id,
                                  "product_id",
                                  parseInt(e.target.value)
                                )
                              }
                              required
                              style={{ width: "100%" }}
                            >
                              <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                              {products.map((p) => (
                                <option key={p.id} value={p.id}>
                                  {p.name} - {p.price?.toLocaleString("vi-VN")}‚Ç´
                                </option>
                              ))}
                            </select>
                          </div>

                          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: "8px" }}>
                            <div>
                              <label style={{ fontSize: "13px", display: "block", marginBottom: "4px" }}>
                                S·ªë l∆∞·ª£ng
                              </label>
                              <input
                                type="number"
                                min="1"
                                value={item.quantity}
                                onChange={(e) =>
                                  updateItemInNewOrder(
                                    item.id,
                                    "quantity",
                                    parseInt(e.target.value)
                                  )
                                }
                                required
                              />
                            </div>

                            <div>
                              <label style={{ fontSize: "13px", display: "block", marginBottom: "4px" }}>
                                Th√†nh ti·ªÅn
                              </label>
                              <input
                                type="text"
                                value={calculateSubtotal(item).toLocaleString("vi-VN") + "‚Ç´"}
                                disabled
                                style={{ background: "#f0f0f0", cursor: "not-allowed" }}
                              />
                            </div>

                            <div>
                              <label style={{ fontSize: "13px", display: "block", marginBottom: "4px" }}>
                                Ghi ch√∫
                              </label>
                              <input
                                type="text"
                                value={item.notes}
                                onChange={(e) =>
                                  updateItemInNewOrder(item.id, "notes", e.target.value)
                                }
                                placeholder="Ghi ch√∫"
                              />
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p style={{ textAlign: "center", color: "var(--text-secondary)", padding: "20px" }}>
                    Ch∆∞a c√≥ m√≥n n√†o. Nh·∫•n "Th√™m m√≥n" ƒë·ªÉ th√™m.
                  </p>
                )}
              </div>

              <div className="modal-actions">
                <button type="submit" className="btn save-btn">
                  T·∫°o ƒë∆°n
                </button>
                <button
                  type="button"
                  className="btn cancel-btn"
                  onClick={() => {
                    setShowAddForm(false);
                    setNewOrder({ table_id: "", items: [] });
                  }}
                >
                  H·ªßy
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* --- Edit Modal --- */}
      {showEditForm && (
        <div className="modal-overlay">
          <div className="modal" style={{ maxWidth: "700px" }}>
            <h2>C·∫≠p nh·∫≠t ƒë∆°n h√†ng #{editOrder.id}</h2>
            <form onSubmit={handleUpdateSubmit}>
              <div>
                <label>B√†n</label>
                <select
                  value={editOrder.table_id || editOrder.table?.id || ""}
                  onChange={(e) =>
                    setEditOrder({
                      ...editOrder,
                      table_id: parseInt(e.target.value),
                    })
                  }
                  required
                >
                  <option value="">-- Ch·ªçn b√†n --</option>
                  {tables.map((table) => (
                    <option key={table.id} value={table.id}>
                      B√†n {table.id} - {table.status}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label>Tr·∫°ng th√°i</label>
                <select
                  value={editOrder.status || ""}
                  onChange={(e) =>
                    setEditOrder({ ...editOrder, status: e.target.value })
                  }
                >
                  <option value="Pending">Pending</option>
                  <option value="Processed">Processed</option>
                  <option value="Delivered">Delivered</option>
                  <option value="Canceled">Canceled</option>
                </select>
              </div>

              <div style={{ marginTop: "20px" }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "12px" }}>
                  <label style={{ margin: 0 }}>Danh s√°ch m√≥n</label>
                  <button
                    type="button"
                    className="btn add-btn"
                    style={{ padding: "8px 16px", fontSize: "13px" }}
                    onClick={addItemToEditOrder}
                  >
                    + Th√™m m√≥n
                  </button>
                </div>

                {editOrder.items && editOrder.items.length > 0 ? (
                  <div style={{ display: "flex", flexDirection: "column", gap: "12px" }}>
                    {editOrder.items.map((item, index) => (
                      <div
                        key={item.id}
                        style={{
                          border: "1px solid var(--border-color)",
                          borderRadius: "8px",
                          padding: "12px",
                          background: "var(--bg-secondary)",
                        }}
                      >
                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "8px" }}>
                          <strong>M√≥n #{index + 1}</strong>
                          <button
                            type="button"
                            onClick={() => removeItemFromEditOrder(item.id)}
                            style={{
                              background: "var(--danger-color)",
                              color: "white",
                              border: "none",
                              borderRadius: "6px",
                              padding: "4px 12px",
                              cursor: "pointer",
                              fontSize: "12px",
                            }}
                          >
                            X√≥a
                          </button>
                        </div>

                        <div style={{ display: "grid", gap: "8px" }}>
                          <div>
                            <label style={{ fontSize: "13px", display: "block", marginBottom: "4px" }}>
                              S·∫£n ph·∫©m
                            </label>
                            <select
                              value={item.product_id || item.product?.id || ""}
                              onChange={(e) =>
                                updateItemInEditOrder(
                                  item.id,
                                  "product_id",
                                  parseInt(e.target.value)
                                )
                              }
                              required
                              style={{ width: "100%" }}
                            >
                              <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                              {products.map((p) => (
                                <option key={p.id} value={p.id}>
                                  {p.name} - {p.price?.toLocaleString("vi-VN")}‚Ç´
                                </option>
                              ))}
                            </select>
                          </div>

                          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: "8px" }}>
                            <div>
                              <label style={{ fontSize: "13px", display: "block", marginBottom: "4px" }}>
                                S·ªë l∆∞·ª£ng
                              </label>
                              <input
                                type="number"
                                min="1"
                                value={item.quantity}
                                onChange={(e) =>
                                  updateItemInEditOrder(
                                    item.id,
                                    "quantity",
                                    parseInt(e.target.value)
                                  )
                                }
                                required
                              />
                            </div>

                            <div>
                              <label style={{ fontSize: "13px", display: "block", marginBottom: "4px" }}>
                                Th√†nh ti·ªÅn
                              </label>
                              <input
                                type="text"
                                value={calculateEditSubtotal(item).toLocaleString("vi-VN") + "‚Ç´"}
                                disabled
                                style={{ background: "#f0f0f0", cursor: "not-allowed" }}
                              />
                            </div>

                            <div>
                              <label style={{ fontSize: "13px", display: "block", marginBottom: "4px" }}>
                                Ghi ch√∫
                              </label>
                              <input
                                type="text"
                                value={item.notes || ""}
                                onChange={(e) =>
                                  updateItemInEditOrder(item.id, "notes", e.target.value)
                                }
                                placeholder="Ghi ch√∫"
                              />
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p style={{ textAlign: "center", color: "var(--text-secondary)", padding: "20px" }}>
                    Ch∆∞a c√≥ m√≥n n√†o. Nh·∫•n "Th√™m m√≥n" ƒë·ªÉ th√™m.
                  </p>
                )}
              </div>

              <div className="modal-actions">
                <button type="submit" className="btn save-btn">
                  C·∫≠p nh·∫≠t
                </button>
                <button
                  type="button"
                  className="btn cancel-btn"
                  onClick={() => setShowEditForm(false)}
                >
                  H·ªßy
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* --- Order Details Dialog --- */}
      {showDetailsDialog && (
        <div 
          className="modal-overlay" 
          style={{ justifyContent: 'flex-end', alignItems: 'stretch' }}
        >
          <div 
            className="order-details-sidebar"
          >
            {/* Header */}
            <div className="order-details-header">
              <div>
                <h2>Chi ti·∫øt ƒë∆°n h√†ng</h2>
                <p className="order-id">#{editOrder.id}</p>
              </div>
              <button 
                className="close-btn"
                onClick={() => {
                  setShowDetailsDialog(false);
                  setOrderItems([]);
                }}
              >
                ‚úï
              </button>
            </div>

            {/* Order Info */}
            <div className="order-info-section">
              <div className="info-row">
                <span className="info-label">B√†n</span>
                <span className="info-value">B√†n {editOrder.table?.id || '‚Äî'}</span>
              </div>
              <div className="info-row">
                <span className="info-label">Tr·∫°ng th√°i</span>
                <span className={`status-badge status-${editOrder.status?.toLowerCase()}`}>
                  {editOrder.status}
                </span>
              </div>
              <div className="info-row">
                <span className="info-label">Ng√†y t·∫°o</span>
                <span className="info-value">
                  {editOrder.createdAt ? new Date(editOrder.createdAt).toLocaleString('vi-VN') : '‚Äî'}
                </span>
              </div>
            </div>

            {/* Items List */}
            <div className="order-items-section">
              <h3 className="section-title">
                üçΩÔ∏è Danh s√°ch m√≥n ({orderItems.length})
              </h3>
              <div className="items-list">
                {orderItems.length > 0 ? (
                  orderItems.map((item) => (
                    <div key={item.id} className="order-item-card">
                      <div className="item-header">
                        <div className="item-info">
                          <h4 className="item-name">{item.product?.name || '‚Äî'}</h4>
                          <p className="item-quantity">S·ªë l∆∞·ª£ng: {item.quantity}</p>
                        </div>
                        <div className="item-price">
                          <p className="item-unit-price">
                            {item.product?.price?.toLocaleString("vi-VN")}‚Ç´/m√≥n
                          </p>
                          <p className="item-total-price">
                            {item.subtotal?.toLocaleString("vi-VN")}‚Ç´
                          </p>
                        </div>
                      </div>
                      {item.notes && (
                        <p className="item-notes">
                          <span className="notes-icon">üìù</span>
                          {item.notes}
                        </p>
                      )}
                    </div>
                  ))
                ) : (
                  <div className="empty-state">
                    <span className="empty-icon">üì¶</span>
                    <p>Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o</p>
                  </div>
                )}
              </div>
            </div>

            {/* Footer with Total */}
            <div className="order-details-footer">
              <div className="total-section">
                <div className="total-row">
                  <span className="total-label">T·ªïng c·ªông</span>
                  <span className="total-amount">
                    {editOrder.total_amount?.toLocaleString("vi-VN")}‚Ç´
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </>
  );
};

export default ChooseOrder;
